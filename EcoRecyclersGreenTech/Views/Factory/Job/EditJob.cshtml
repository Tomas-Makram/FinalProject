@model EcoRecyclersGreenTech.Models.FactoryStore.Products.JobModel
@using EcoRecyclersGreenTech.Data.Stores

@{
    ViewData["Title"] = "Edit Job";
    var nonce = Context.Items["CSPNonce"] as string ?? string.Empty;

    var canModify = ViewBag.CanModify as bool? ?? true;

    decimal defaultLat = 30.0444m, defaultLng = 31.2357m;

    var hasCoords = Model?.Latitude.HasValue == true && Model?.Longitude.HasValue == true;
    var startLat = hasCoords ? Model!.Latitude!.Value : defaultLat;
    var startLng = hasCoords ? Model!.Longitude!.Value : defaultLng;

    var expiryValue = Model?.ExpiryDate.HasValue == true
        ? Model!.ExpiryDate!.Value.ToString("yyyy-MM-ddTHH:mm")
        : "";
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-action="Index">Dashboard</a></li>
                    <li class="breadcrumb-item"><a asp-action="Jobs">Jobs</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Edit Job</li>
                </ol>
            </nav>

            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient-warning border-0 py-4">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="bi bi-pencil-square fs-1 text-white"></i>
                        </div>
                        <div>
                            <h2 class="card-title mb-1 text-white">Edit Job</h2>
                            <p class="text-white-50 mb-0">Update the details of your job posting</p>
                        </div>
                    </div>
                </div>

                <form asp-action="EditJob"
                      asp-route-id="@Model.Id"
                      method="post"
                      class="needs-validation"
                      novalidate>

                    @Html.AntiForgeryToken()
                    @Html.HiddenFor(m => m.Id)

                    @if (!canModify)
                    {
                        @* Freeze values for POST *@
                        @Html.HiddenFor(m => m.Status)
                        @Html.HiddenFor(m => m.JobType)
                        @Html.HiddenFor(m => m.WorkHours)
                        @Html.HiddenFor(m => m.Latitude)
                        @Html.HiddenFor(m => m.Longitude)
                        @Html.HiddenFor(m => m.Location)
                        @Html.HiddenFor(m => m.Salary)
                        @Html.HiddenFor(m => m.ExpiryDate)
                        @Html.HiddenFor(m => m.RequiredSkills)
                        @Html.HiddenFor(m => m.ExperienceLevel)
                        @Html.HiddenFor(m => m.EmploymentType)
                        @Html.HiddenFor(m => m.Description)
                    }

                    @if (!canModify)
                    {
                        <div class="alert alert-info border-0 rounded-0 mb-0">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-lock-fill fs-4 me-3"></i>
                                <div>
                                    <h5 class="alert-heading mb-1">Editing Locked</h5>
                                    <p class="mb-0">This job already has orders, so you cannot edit it. You can still delete it anytime.</p>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="card-body p-4 p-md-5">

                        <div asp-validation-summary="ModelOnly" class="alert alert-danger rounded-3 mb-4">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            Please fix the errors below
                        </div>

                        <div class="row g-4">

                            <!-- ✅ Status -->
                            <div class="col-12">
                                <div class="card border-0 bg-light-subtle mb-4">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">
                                            <i class="bi bi-toggle-on me-2 text-secondary"></i>
                                            Status
                                        </h5>

                                        <div class="form-floating">
                                            <select asp-for="Status" class="form-select" required disabled="@(canModify ? null : "disabled")">
                                                <option value="Available">Available</option>
                                                <option value="Reserved">Reserved</option>
                                                <option value="SoldOut">Sold Out</option>
                                                <option value="Inactive">Inactive</option>
                                            </select>
                                            <label asp-for="Status">Current Status *</label>
                                            <span asp-validation-for="Status" class="text-danger small"></span>

                                            @if (!canModify)
                                            {
                                                <div class="form-text text-warning">
                                                    <i class="bi bi-lock me-1"></i>Locked
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ✅ Location Picker -->
                            <div class="col-12">
                                <div class="card border-0 bg-light-subtle mb-4">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">
                                            <i class="bi bi-geo-alt-fill me-2 text-success"></i>
                                            Location
                                        </h5>

                                        <div class="position-relative">
                                            @if (!canModify)
                                            {
                                                <div class="position-absolute top-0 start-0 w-100 h-100"
                                                     style="z-index: 5; background: rgba(255,255,255,0.72); border-radius:12px;"></div>
                                            }

                                            <div class="p-3 rounded" style="border:1px solid #e9ecef;background:#fff; border-radius:12px;">
                                                <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
                                                    <div class="d-flex gap-2 flex-wrap">
                                                        <button type="button" class="btn btn-success" id="btnUseMyLocation" disabled="@(canModify ? null : "disabled")">
                                                            <i class="bi bi-geo-alt me-1"></i> Use GPS
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary" id="btnClearLocation" disabled="@(canModify ? null : "disabled")">
                                                            <i class="bi bi-x-circle me-1"></i> Clear
                                                        </button>
                                                    </div>

                                                    <div class="small text-muted" id="locationStatus">
                                                        Search for a place (Arabic/English), then select a result or click the map.
                                                    </div>
                                                </div>

                                                <input asp-for="Latitude" type="hidden" id="Latitude" />
                                                <input asp-for="Longitude" type="hidden" id="Longitude" />

                                                <div class="row g-3 mt-2">
                                                    <div class="col-12">
                                                        <div class="form-floating">
                                                            <input asp-for="Location"
                                                                   class="form-control"
                                                                   id="Location"
                                                                   placeholder="Cairo, Giza..."
                                                                   required
                                                                   disabled="@(canModify ? null : "disabled")" />
                                                            <label asp-for="Location"><i class="bi bi-geo-alt me-1"></i>Location *</label>
                                                            <span asp-validation-for="Location" class="text-danger small"></span>
                                                        </div>
                                                    </div>

                                                    <div class="col-12">
                                                        <label class="form-label small fw-semibold text-success mb-1">Search Place</label>
                                                        <div class="input-group">
                                                            <input type="text" class="form-control" id="txtPlaceSearch"
                                                                   placeholder="Type place name..."
                                                                   autocomplete="off"
                                                                   disabled="@(canModify ? null : "disabled")" />
                                                            <button class="btn btn-success" type="button" id="btnPlaceSearch" disabled="@(canModify ? null : "disabled")">
                                                                <i class="fas fa-search me-1"></i> Search
                                                            </button>
                                                        </div>
                                                        <div class="form-text small" id="searchStatus">Type to see suggestions, or press Search.</div>

                                                        <div class="mt-2" id="searchResultsWrap" style="display:none;">
                                                            <div class="small fw-semibold text-success mb-1">Results</div>
                                                            <div class="list-group" id="searchResults"></div>
                                                        </div>

                                                        <div class="alert alert-warning mt-2 py-2" id="searchError" style="display:none;">
                                                            <div class="small" id="searchErrorText"></div>
                                                        </div>
                                                    </div>

                                                    <div class="col-12">
                                                        <div id="map" style="height: 420px; border-radius: 12px; overflow: hidden; border: 1px solid #e0e0e0;"></div>

                                                        <div class="mt-2 p-2 rounded" style="background:#f8f9fa;border:1px solid #e9ecef">
                                                            <div class="small fw-semibold text-success mb-1">Selected Location</div>
                                                            <div class="small text-muted" id="selectedDetails">
                                                                @(string.IsNullOrWhiteSpace(Model.Location) ? "No location selected yet." : Model.Location)
                                                            </div>
                                                            <div class="small text-muted mt-1" id="selectedCoords"></div>
                                                        </div>

                                                        <div class="small text-muted mt-2">
                                                            Tip: Click on the map or drag the pin to set the exact spot.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>

                                    </div>
                                </div>
                            </div>

                            <!-- ✅ Job Details -->
                            <div class="col-12">
                                <div class="card border-0 bg-light-subtle mb-4">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">
                                            <i class="bi bi-info-circle-fill me-2 text-primary"></i>
                                            Job Details
                                        </h5>

                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="form-floating">
                                                    <input asp-for="JobType" class="form-control" required disabled="@(canModify ? null : "disabled")" />
                                                    <label asp-for="JobType"><i class="bi bi-briefcase me-1"></i>Job Type *</label>
                                                    <span asp-validation-for="JobType" class="text-danger small"></span>
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <div class="form-floating">
                                                    <input asp-for="WorkHours" type="number" class="form-control" min="1" max="24" required disabled="@(canModify ? null : "disabled")" />
                                                    <label asp-for="WorkHours"><i class="bi bi-clock me-1"></i>Work Hours *</label>
                                                    <span asp-validation-for="WorkHours" class="text-danger small"></span>
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <div class="form-floating">
                                                    <input asp-for="Salary" type="number" class="form-control" min="0.01" step="0.01" required disabled="@(canModify ? null : "disabled")" />
                                                    <label asp-for="Salary"><i class="bi bi-cash-stack me-1"></i>Salary *</label>
                                                    <span asp-validation-for="Salary" class="text-danger small"></span>
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <div class="form-floating">
                                                    <input asp-for="ExpiryDate"
                                                           type="datetime-local"
                                                           class="form-control"
                                                           value="@expiryValue"
                                                           disabled="@(canModify ? null : "disabled")" />
                                                    <label asp-for="ExpiryDate"><i class="bi bi-calendar2-x me-1"></i>Expiry (Date & Time)</label>
                                                    <span asp-validation-for="ExpiryDate" class="text-danger small"></span>
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <div class="form-floating">
                                                    <input asp-for="ExperienceLevel" class="form-control" disabled="@(canModify ? null : "disabled")" />
                                                    <label asp-for="ExperienceLevel"><i class="bi bi-graph-up me-1"></i>Experience Level</label>
                                                    <span asp-validation-for="ExperienceLevel" class="text-danger small"></span>
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <div class="form-floating">
                                                    <input asp-for="EmploymentType" class="form-control" disabled="@(canModify ? null : "disabled")" />
                                                    <label asp-for="EmploymentType"><i class="bi bi-person-workspace me-1"></i>Employment Type</label>
                                                    <span asp-validation-for="EmploymentType" class="text-danger small"></span>
                                                </div>
                                            </div>

                                            <div class="col-12">
                                                <div class="form-floating">
                                                    <input asp-for="RequiredSkills" class="form-control" disabled="@(canModify ? null : "disabled")" />
                                                    <label asp-for="RequiredSkills"><i class="bi bi-stars me-1"></i>Required Skills</label>
                                                    <span asp-validation-for="RequiredSkills" class="text-danger small"></span>
                                                </div>
                                            </div>

                                        </div>

                                    </div>
                                </div>
                            </div>

                            <!-- ✅ Description -->
                            <div class="col-12">
                                <div class="card border-0 bg-light-subtle">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">
                                            <i class="bi bi-card-text me-2 text-info"></i>
                                            Description
                                        </h5>

                                        <div class="form-floating">
                                            <textarea asp-for="Description"
                                                      class="form-control"
                                                      style="height: 160px"
                                                      required
                                                      disabled="@(canModify ? null : "disabled")"></textarea>
                                            <label asp-for="Description">Description *</label>
                                            <span asp-validation-for="Description" class="text-danger small"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="card-footer bg-light border-0 py-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Fields marked with * are required
                            </small>

                            <div class="d-flex gap-2">
                                <a asp-action="Jobs" class="btn btn-outline-secondary px-4">
                                    <i class="bi bi-x-circle me-2"></i>Cancel
                                </a>

                                @if (canModify)
                                {
                                    <button type="submit" class="btn btn-warning px-4" id="submitBtn">
                                        <i class="bi bi-save me-2"></i>Update Job
                                    </button>
                                }
                                else
                                {
                                    <button type="button" class="btn btn-secondary px-4" disabled>
                                        <i class="bi bi-lock me-2"></i>Editing Locked
                                    </button>
                                }
                            </div>
                        </div>
                    </div>

                </form>
            </div>

        </div>
    </div>
</div>

@section Scripts {

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script nonce="@nonce" src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script nonce="@nonce">
    document.addEventListener('DOMContentLoaded', function () {

        const canModify = @((canModify) ? "true" : "false");

        const form = document.querySelector('form.needs-validation');
        if (form && canModify) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                    form.classList.add('was-validated');
                    return;
                }
                form.classList.add('was-validated');

                const submitBtn = document.getElementById('submitBtn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';
                }
            }, false);
        }

        // ============= Location Picker (your same logic) =============
        const btnUseMyLocation = document.getElementById('btnUseMyLocation');
        const btnClearLocation = document.getElementById('btnClearLocation');
        const locationStatus = document.getElementById('locationStatus');

        const latInput = document.getElementById('Latitude');
        const lngInput = document.getElementById('Longitude');
        const locationInput = document.getElementById('Location');

        const txtPlaceSearch = document.getElementById('txtPlaceSearch');
        const btnPlaceSearch = document.getElementById('btnPlaceSearch');
        const searchStatus = document.getElementById('searchStatus');
        const searchResultsWrap = document.getElementById('searchResultsWrap');
        const searchResults = document.getElementById('searchResults');

        const searchError = document.getElementById('searchError');
        const searchErrorText = document.getElementById('searchErrorText');

        const selectedDetails = document.getElementById('selectedDetails');
        const selectedCoords = document.getElementById('selectedCoords');

        function setUiError(msg) {
            searchErrorText.textContent = msg;
            searchError.style.display = 'block';
        }
        function clearUiError() {
            searchError.style.display = 'none';
            searchErrorText.textContent = '';
        }
        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        const startLat = @startLat.ToString(System.Globalization.CultureInfo.InvariantCulture);
        const startLng = @startLng.ToString(System.Globalization.CultureInfo.InvariantCulture);
        const hasCoords = @((hasCoords) ? "true" : "false");

        const map = L.map('map', { zoomControl: true }).setView([startLat, startLng], hasCoords ? 16 : 12);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap &copy; CARTO'
        }).addTo(map);

        let marker = L.marker([startLat, startLng], { draggable: true }).addTo(map);

        if (hasCoords) {
            selectedCoords.textContent = `Lat: ${Number(startLat).toFixed(6)} , Lng: ${Number(startLng).toFixed(6)}`;
        }
        if (!canModify) marker.dragging.disable();

        function setLatLng(lat, lng, zoom, statusMsg, shouldReverse = true) {
            latInput.value = String(lat);
            lngInput.value = String(lng);

            marker.setLatLng([lat, lng]);
            map.setView([lat, lng], zoom ?? map.getZoom());

            selectedCoords.textContent = `Lat: ${lat.toFixed(6)} , Lng: ${lng.toFixed(6)}`;
            if (statusMsg) locationStatus.textContent = statusMsg;

            if (shouldReverse) reverseGeocodeDebounced(lat, lng);
        }

        let reverseTimer = null;
        function reverseGeocodeDebounced(lat, lng) {
            if (reverseTimer) clearTimeout(reverseTimer);
            reverseTimer = setTimeout(() => reverseGeocode(lat, lng), 400);
        }

        async function reverseGeocode(lat, lng) {
            try {
                selectedDetails.textContent = 'Loading location details...';
                locationStatus.textContent = 'Loading address from server...';

                const url = `@Url.Action("ReverseGeocode", "Factory")?lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}`;
                const res = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();
                const display = (data && data.address) ? data.address : 'Unknown place';

                selectedDetails.textContent = display;

                if (display && display !== 'Unknown place' && canModify) {
                    locationInput.value = display.length > 250 ? display.substring(0, 250) : display;
                }

                locationStatus.textContent = 'Address loaded successfully.';
            } catch (err) {
                console.error('ReverseGeocode failed:', err);
                selectedDetails.textContent = 'Could not load address details. You can still submit coordinates.';
                locationStatus.textContent = 'Saved coordinates, but address lookup failed.';
            }
        }

        if (canModify) {
            map.on('click', function (e) {
                clearUiError();
                setLatLng(e.latlng.lat, e.latlng.lng, map.getZoom(), 'Selected by clicking the map.', true);
            });

            marker.on('dragend', function () {
                clearUiError();
                const p = marker.getLatLng();
                setLatLng(p.lat, p.lng, map.getZoom(), 'Selected by dragging the pin.', true);
            });
        }

        function renderResults(items) {
            searchResults.innerHTML = '';
            if (!items || items.length === 0) {
                searchResultsWrap.style.display = 'none';
                return;
            }

            searchResultsWrap.style.display = 'block';

            for (const item of items) {
                const lat = parseFloat(item.lat);
                const lng = parseFloat(item.lon);
                const display = item.display_name || 'Unknown';

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'list-group-item list-group-item-action';
                btn.innerHTML = `
                    <div class="fw-semibold small">${escapeHtml(display)}</div>
                    <div class="text-muted small">Lat: ${lat.toFixed(5)} , Lng: ${lng.toFixed(5)}</div>
                `;

                btn.addEventListener('click', function () {
                    if (!canModify) return;

                    clearUiError();
                    setLatLng(lat, lng, 16, 'Selected from search results.', false);

                    selectedDetails.textContent = display;
                    selectedCoords.textContent = `Lat: ${lat.toFixed(6)} , Lng: ${lng.toFixed(6)}`;

                    locationInput.value = display.length > 250 ? display.substring(0, 250) : display;

                    searchResultsWrap.style.display = 'none';
                    searchStatus.textContent = 'Location selected. You can refine by dragging the pin or clicking the map.';
                });

                searchResults.appendChild(btn);
            }
        }

        async function doSearch(query) {
            clearUiError();
            const q = (query || '').trim();
            if (!q) {
                searchStatus.textContent = 'Type a place name then click Search.';
                searchResultsWrap.style.display = 'none';
                return;
            }

            searchStatus.textContent = 'Searching...';
            btnPlaceSearch.disabled = true;
            searchResultsWrap.style.display = 'none';
            searchResults.innerHTML = '';

            try {
                const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=8&addressdetails=1`;
                const res = await fetch(url, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json', 'Accept-Language': 'en,ar' }
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();
                if (!Array.isArray(data) || data.length === 0) {
                    searchStatus.textContent = 'No results. Try adding city/governorate.';
                    renderResults([]);
                    return;
                }

                searchStatus.textContent = `Found ${data.length} results. Click one to select.`;
                renderResults(data);
            } catch (err) {
                console.error(err);
                searchStatus.textContent = 'Search failed.';
                renderResults([]);
                setUiError('Search request blocked (CORS/CSP) or rate-limited. Route search through backend if needed.');
            } finally {
                btnPlaceSearch.disabled = false;
            }
        }

        btnPlaceSearch.addEventListener('click', () => { if (canModify) doSearch(txtPlaceSearch.value); });

        txtPlaceSearch.addEventListener('keydown', function (e) {
            if (!canModify) return;
            if (e.key === 'Enter') { e.preventDefault(); doSearch(txtPlaceSearch.value); }
        });

        setTimeout(() => map.invalidateSize(), 350);
    });
    </script>

    <style nonce="@nonce">
        .card { border-radius: 12px; overflow: hidden; }
        .card-header.bg-gradient-warning { background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%); }
        .bg-light-subtle { background-color: rgba(248, 249, 250, 0.55) !important; border: 1px solid rgba(0,0,0,0.05); }
        #searchResults .list-group-item { cursor: pointer; }
    </style>
}