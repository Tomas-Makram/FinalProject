@model EcoRecyclersGreenTech.Models.Store.StoreIndexModel
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Store";
    var nonce = HttpContextAccessor.HttpContext?.Items["CSPNonce"] as string ?? "";

    // detect CraftsMan
    var type = (ViewBag.Type?.ToString() ?? ViewBag.type?.ToString() ?? "");
    bool isCraftsMan = string.Equals(type, "Craftsman", StringComparison.OrdinalIgnoreCase)
                    || string.Equals(type, "CraftsMan", StringComparison.OrdinalIgnoreCase);

    string activeType = (Model.Type ?? "").Trim();
}

<style nonce="@nonce">
    /* ===================== THEME TOKENS (Light/Dark) ===================== */
    :root {
        --brand-1: #2ecc71;
        --brand-2: #27ae60;
        --brand-3: #16a085;
        --bg: #ffffff;
        --fg: #1f2937;
        --muted: rgba(0,0,0,.62);
        --soft: rgba(0,0,0,.06);
        --soft-2: rgba(0,0,0,.08);
        --card: #ffffff;
        --border: rgba(0,0,0,.10);
        --shadow: 0 16px 40px rgba(0,0,0,.10);
        --btn-fg: #0f172a;
        --btn-bg: rgba(46,204,113,.12);
        --btn-br: rgba(46,204,113,.28);
        --btn-solid-bg: linear-gradient(135deg, rgba(46,204,113,1), rgba(39,174,96,1));
        --btn-solid-fg: #ffffff;
        --btn-solid-shadow: 0 10px 24px rgba(46,204,113,.25);
        --tile-bg: rgba(255,255,255,1);
        --tile-br: rgba(0,0,0,.10);
        --tile-ico-bg: rgba(46,204,113,.12);
        --tile-ico-br: rgba(46,204,113,.22);
        --tile-ico-fg: #1f7a49;
        --badge-bg: rgba(52,152,219,.12);
        --badge-br: rgba(52,152,219,.18);
        --badge-fg: #21618c;
        --type-bg: rgba(46,204,113,.12);
        --type-br: rgba(46,204,113,.22);
        --type-fg: #1f7a49;
    }

    [data-bs-theme="dark"] {
        --bg: #0f172a;
        --fg: rgba(255,255,255,.92);
        --muted: rgba(255,255,255,.68);
        --soft: rgba(255,255,255,.06);
        --soft-2: rgba(255,255,255,.08);
        --card: #111c34;
        --border: rgba(255,255,255,.10);
        --shadow: 0 18px 44px rgba(0,0,0,.38);
        --btn-fg: rgba(255,255,255,.92);
        --btn-bg: rgba(46,204,113,.14);
        --btn-br: rgba(46,204,113,.28);
        --tile-bg: rgba(17,28,52,1);
        --tile-br: rgba(255,255,255,.10);
        --tile-ico-bg: rgba(46,204,113,.16);
        --tile-ico-br: rgba(46,204,113,.26);
        --tile-ico-fg: rgba(46,204,113,.95);
        --badge-bg: rgba(52,152,219,.14);
        --badge-br: rgba(52,152,219,.24);
        --badge-fg: rgba(173,216,255,.95);
        --type-bg: rgba(46,204,113,.16);
        --type-br: rgba(46,204,113,.26);
        --type-fg: rgba(46,204,113,.95);
    }

    /* ===================== HERO ===================== */
    .store-hero {
        background: linear-gradient(135deg, rgba(46,204,113,0.98), rgba(39,174,96,0.96));
        color: #fff;
        border-radius: 18px;
        padding: 34px;
        margin-bottom: 18px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,.14);
    }

        .store-hero::after {
            content: "";
            position: absolute;
            right: -90px;
            top: -90px;
            width: 240px;
            height: 240px;
            border-radius: 50%;
            background: rgba(255,255,255,.12);
            filter: blur(0.2px);
        }

        .store-hero .muted-2 {
            opacity: .9;
            color: rgba(255,255,255,.92);
        }

    /* ===================== NAV PANEL ===================== */
    .nav-panel {
        border-radius: 18px;
        border: 1px solid var(--border);
        overflow: hidden;
        box-shadow: 0 12px 30px rgba(0,0,0,.08);
        background: var(--card);
    }

    [data-bs-theme="dark"] .nav-panel {
        box-shadow: 0 14px 34px rgba(0,0,0,.42);
    }

    .nav-panel .panel-head {
        padding: 14px 18px;
        background: linear-gradient(135deg, var(--soft), rgba(46,204,113,.08));
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
    }

    .nav-panel .panel-title {
        font-weight: 900;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--fg);
    }

    .nav-panel .panel-head .text-muted {
        color: var(--muted) !important;
    }

    .nav-grid {
        padding: 14px;
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 10px;
    }

    @@media(max-width:1200px) {
        .nav-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
    }

    @@media(max-width:768px) {
        .nav-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    .nav-tile {
        border-radius: 16px;
        border: 1px solid var(--tile-br);
        background: var(--tile-bg);
        padding: 12px 12px;
        text-decoration: none;
        color: var(--fg);
        transition: .2s ease;
        display: flex;
        gap: 10px;
        align-items: center;
        position: relative;
        overflow: hidden;
    }

        .nav-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 14px 30px rgba(0,0,0,.12);
            border-color: rgba(46,204,113,.45);
        }

    [data-bs-theme="dark"] .nav-tile:hover {
        box-shadow: 0 16px 34px rgba(0,0,0,.55);
    }

    .nav-tile.active {
        border-color: rgba(46,204,113,.65);
        background: linear-gradient(135deg, rgba(46,204,113,.12), var(--tile-bg));
    }

    .nav-ico {
        width: 42px;
        height: 42px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--tile-ico-bg);
        border: 1px solid var(--tile-ico-br);
        flex: 0 0 auto;
    }

        .nav-ico i {
            font-size: 1.25rem;
            color: var(--tile-ico-fg);
        }

    .nav-meta {
        min-width: 0;
    }

        .nav-meta .t {
            font-weight: 900;
            line-height: 1.2;
            margin: 0;
            font-size: .98rem;
            color: var(--fg);
        }

        .nav-meta .s {
            margin: 0;
            font-size: .82rem;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    .nav-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: .74rem;
        padding: 3px 10px;
        border-radius: 999px;
        background: var(--badge-bg);
        border: 1px solid var(--badge-br);
        color: var(--badge-fg);
        font-weight: 800;
    }

    /* ===================== FILTERS ===================== */
    .filter-pill .btn {
        border-radius: 999px;
        font-weight: 800;
        padding: 8px 14px;
        border-width: 1px;
    }

    /* Improve outline buttons in dark */
    [data-bs-theme="dark"] .btn-outline-success {
        color: rgba(46,204,113,.95);
        border-color: rgba(46,204,113,.45);
    }

        [data-bs-theme="dark"] .btn-outline-success:hover {
            background: rgba(46,204,113,.12);
            border-color: rgba(46,204,113,.65);
        }

    [data-bs-theme="dark"] .btn-outline-secondary {
        color: rgba(255,255,255,.84);
        border-color: rgba(255,255,255,.22);
    }

        [data-bs-theme="dark"] .btn-outline-secondary:hover {
            background: rgba(255,255,255,.08);
            border-color: rgba(255,255,255,.30);
        }

    /* ===================== CARDS ===================== */
    .store-card {
        border-radius: 18px;
        border: 1px solid var(--border);
        transition: .25s ease;
        overflow: hidden;
        height: 100%;
        background: var(--card);
    }

        .store-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 14px 30px rgba(0,0,0,.14);
            border-color: rgba(46,204,113,.35);
        }

    [data-bs-theme="dark"] .store-card:hover {
        box-shadow: 0 18px 40px rgba(0,0,0,.60);
    }

    .type-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 4px 10px;
        font-weight: 900;
        font-size: .8rem;
        background: var(--type-bg);
        border: 1px solid var(--type-br);
        color: var(--type-fg);
    }

    .price {
        font-size: 1.05rem;
        font-weight: 950;
        color: var(--fg);
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .text-muted {
        color: var(--muted) !important;
    }

    /* ===================== BUTTONS (Pretty) ===================== */
    .btn-solid-eco {
        border: 0;
        color: var(--btn-solid-fg) !important;
        background: var(--btn-solid-bg);
        box-shadow: var(--btn-solid-shadow);
        font-weight: 900;
        border-radius: 999px;
        padding: .55rem .9rem;
        transition: .18s ease;
    }

        .btn-solid-eco:hover {
            transform: translateY(-1px);
            filter: brightness(1.03);
            box-shadow: 0 14px 30px rgba(46,204,113,.30);
        }

    .btn-soft-eco {
        border-radius: 999px;
        font-weight: 900;
        color: var(--btn-fg);
        background: var(--btn-bg);
        border: 1px solid var(--btn-br);
        transition: .18s ease;
    }

        .btn-soft-eco:hover {
            transform: translateY(-1px);
            border-color: rgba(46,204,113,.55);
            background: rgba(46,204,113,.18);
        }

    /* Footer buttons area */
    .card-footer {
        background: transparent !important;
    }
    /* ===================== NAV SECTIONS ===================== */
    .nav-sections {
        padding: 12px 14px 14px;
        display: grid;
        gap: 14px;
    }

    .nav-section {
        border: 1px solid var(--border);
        border-radius: 16px;
        background: linear-gradient(135deg, var(--soft), transparent);
        overflow: hidden;
    }

    [data-bs-theme="dark"] .nav-section {
        background: linear-gradient(135deg, rgba(255,255,255,.05), transparent);
    }

    .nav-section-head {
        padding: 12px 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        border-bottom: 1px solid var(--border);
    }

    .nav-section-title {
        display: flex;
        gap: 10px;
        align-items: center;
        margin: 0;
        font-weight: 950;
        color: var(--fg);
    }

    .nav-section-sub {
        margin: 0;
        font-size: .86rem;
        color: var(--muted);
        font-weight: 650;
    }

    .nav-grid.section-grid {
        padding: 12px;
        grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    @@media(max-width:1200px) {
        .nav-grid.section-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
    }

    @@media(max-width:768px) {
        .nav-grid.section-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    /* Make bottom text clearer */
    .nav-meta .s {
        white-space: normal;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.25;
    }

    /* Badge variants */
    .nav-badge.store {
        background: rgba(46,204,113,.14);
        border: 1px solid rgba(46,204,113,.26);
        color: var(--type-fg);
    }

    .nav-badge.orders {
        background: rgba(241,196,15,.14);
        border: 1px solid rgba(241,196,15,.26);
        color: #9a7b00;
    }

    [data-bs-theme="dark"] .nav-badge.orders {
        color: rgba(255,220,130,.95);
    }

    /* Slightly different icon for orders tiles */
    .nav-tile.orders .nav-ico {
        background: rgba(241,196,15,.14);
        border-color: rgba(241,196,15,.26);
    }

        .nav-tile.orders .nav-ico i {
            color: rgba(241,196,15,.95);
        }

</style>

<div class="store-hero">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
            <h2 class="fw-bold mb-1">Public Store</h2>
            <div class="muted-2">Materials • Machines • Rentals • Auctions</div>
        </div>
        <div class="text-end">
            <div class="fw-semibold">Results</div>
            <div class="fs-3 fw-bold">@Model.Stores.Count</div>
        </div>
    </div>
</div>

@if (isCraftsMan)
{
    <div class="nav-panel mb-4">
        <div class="panel-head">
            <h5 class="panel-title">
                <i class="bi bi-compass"></i> Quick Navigation
            </h5>
            <span class="text-muted small">Jump to stores & your orders</span>
        </div>

        <div class="nav-sections">

            <!-- ===================== STORES SECTION ===================== -->
            <div class="nav-section">
                <div class="nav-section-head">
                    <h6 class="nav-section-title">
                        <i class="bi bi-shop-window"></i> Stores
                    </h6>
                    <p class="nav-section-sub">Browse verified listings by category</p>
                </div>

                <div class="nav-grid section-grid">
                    <a class="nav-tile @(activeType.Equals("Material", StringComparison.OrdinalIgnoreCase) ? "active" : "")"
                       asp-controller="CraftsMan" asp-action="PublicMaterialStore">
                        <div class="nav-ico"><i class="bi bi-box-seam"></i></div>
                        <div class="nav-meta">
                            <p class="t">Materials</p>
                            <p class="s">Raw materials from verified sellers</p>
                        </div>
                        <span class="nav-badge store">Store</span>
                    </a>

                    <a class="nav-tile @(activeType.Equals("Machine", StringComparison.OrdinalIgnoreCase) ? "active" : "")"
                       asp-controller="CraftsMan" asp-action="PublicMachineStore">
                        <div class="nav-ico"><i class="bi bi-gear-wide-connected"></i></div>
                        <div class="nav-meta">
                            <p class="t">Machines</p>
                            <p class="s">Machines & equipment — buy/request delivery</p>
                        </div>
                        <span class="nav-badge store">Store</span>
                    </a>

                    <a class="nav-tile @(activeType.Equals("Rental", StringComparison.OrdinalIgnoreCase) ? "active" : "")"
                       asp-controller="CraftsMan" asp-action="PublicRentalStore">
                        <div class="nav-ico"><i class="bi bi-house-door"></i></div>
                        <div class="nav-meta">
                            <p class="t">Rentals</p>
                            <p class="s">Workspaces & places — booking & payments</p>
                        </div>
                        <span class="nav-badge store">Store</span>
                    </a>

                    <a class="nav-tile @(activeType.Equals("Auction", StringComparison.OrdinalIgnoreCase) ? "active" : "")"
                       asp-controller="CraftsMan" asp-action="PublicAuctionStore">
                        <div class="nav-ico"><i class="bi bi-hammer"></i></div>
                        <div class="nav-meta">
                            <p class="t">Auctions</p>
                            <p class="s">Bid on listings and win deals</p>
                        </div>
                        <span class="nav-badge store">Store</span>
                    </a>
                </div>
            </div>

            <!-- ===================== ORDERS SECTION ===================== -->
            <div class="nav-section">
                <div class="nav-section-head">
                    <h6 class="nav-section-title">
                        <i class="bi bi-receipt"></i> My Orders
                    </h6>
                    <p class="nav-section-sub">Track your requests, payments & status</p>
                </div>

                <div class="nav-grid section-grid">
                    <a class="nav-tile orders" asp-controller="CraftsMan" asp-action="MyMaterialOrders">
                        <div class="nav-ico"><i class="bi bi-receipt-cutoff"></i></div>
                        <div class="nav-meta">
                            <p class="t">Material Orders</p>
                            <p class="s">Deposits, approvals, delivery & cancellation</p>
                        </div>
                        <span class="nav-badge orders">Orders</span>
                    </a>

                    <a class="nav-tile orders" asp-controller="CraftsMan" asp-action="MyMachineOrders">
                        <div class="nav-ico"><i class="bi bi-truck"></i></div>
                        <div class="nav-meta">
                            <p class="t">Machine Orders</p>
                            <p class="s">Track shipping, ETA and order status</p>
                        </div>
                        <span class="nav-badge orders">Orders</span>
                    </a>

                    <a class="nav-tile orders" asp-controller="CraftsMan" asp-action="MyRentalOrders">
                        <div class="nav-ico"><i class="bi bi-journal-check"></i></div>
                        <div class="nav-meta">
                            <p class="t">Rental Orders</p>
                            <p class="s">Bookings, paid months and confirmations</p>
                        </div>
                        <span class="nav-badge orders">Orders</span>
                    </a>

                    <a class="nav-tile orders" asp-controller="CraftsMan" asp-action="MyAuctionOrders">
                        <div class="nav-ico"><i class="bi bi-award"></i></div>
                        <div class="nav-meta">
                            <p class="t">Auction Orders</p>
                            <p class="s">Your bids, deposits and winning auctions</p>
                        </div>
                        <span class="nav-badge orders">Orders</span>
                    </a>
                </div>
            </div>

        </div>
    </div>
}
<form method="get" class="card p-3 mb-3" style="border-radius:18px; border:1px solid var(--border); background:var(--card);">
    <div class="row g-2 align-items-end">
        <div class="col-md-6">
            <label class="form-label fw-semibold">Search</label>
            <input class="form-control" name="q" value="@Model.Query"
                   placeholder="Search by name / description / seller / location..." />
        </div>

        <div class="col-md-3">
            <label class="form-label fw-semibold">Type</label>
            <select class="form-select" name="type">
                <option value="" selected="@(string.IsNullOrWhiteSpace(Model.Type))">All</option>
                <option value="Material" selected="@(Model.Type=="Material")">Material</option>
                <option value="Machine" selected="@(Model.Type=="Machine")">Machine</option>
                <option value="Rental" selected="@(Model.Type=="Rental")">Rental</option>
                <option value="Auction" selected="@(Model.Type=="Auction")">Auction</option>
            </select>
        </div>

        <div class="col-md-3 d-flex gap-2">
            <button class="btn btn-solid-eco w-100">
                <i class="bi bi-search me-1"></i>Search
            </button>
            <a class="btn btn-outline-secondary w-100" href="@Url.Action("Index","Store")">
                Reset
            </a>
        </div>
    </div>

    <div class="filter-pill mt-3 d-flex flex-wrap gap-2">
        <a class="btn btn-outline-success @(string.IsNullOrWhiteSpace(Model.Type) ? "active" : "")"
           href="@Url.Action("Index","Store", new { q = Model.Query, type = "" })">All</a>

        <a class="btn btn-outline-success @(Model.Type=="Material" ? "active" : "")"
           href="@Url.Action("Index","Store", new { q = Model.Query, type = "Material" })">Material</a>

        <a class="btn btn-outline-success @(Model.Type=="Machine" ? "active" : "")"
           href="@Url.Action("Index","Store", new { q = Model.Query, type = "Machine" })">Machine</a>

        <a class="btn btn-outline-success @(Model.Type=="Rental" ? "active" : "")"
           href="@Url.Action("Index","Store", new { q = Model.Query, type = "Rental" })">Rental</a>

        <a class="btn btn-outline-success @(Model.Type=="Auction" ? "active" : "")"
           href="@Url.Action("Index","Store", new { q = Model.Query, type = "Auction" })">Auction</a>
    </div>
</form>

@if (!Model.Stores.Any())
{
    <div class="alert alert-info text-center p-4" style="border-radius:18px;">
        <h5 class="mb-1">No results</h5>
        <small>Try different keyword or type filter.</small>
    </div>
}
else
{
    <div class="row g-3">
        @foreach (var s in Model.Stores)
        {
            <div class="col-lg-4 col-md-6">
                <div class="card store-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start gap-2">
                            <span class="type-badge">
                                <i class="bi bi-tag"></i>@s.Type
                            </span>
                            <small class="text-muted">@s.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd")</small>
                        </div>

                        <h5 class="fw-bold mt-2 mb-1" style="color:var(--fg);">@s.Name</h5>

                        <div class="text-muted small line-clamp-2 mb-2">
                            @(string.IsNullOrWhiteSpace(s.Description) ? "No description" : s.Description)
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="price">
                                @if (s.Price.HasValue)
                                {
                                    @s.Price.Value.ToString("0.00") <span class="text-muted fs-6">@s.Currency</span>
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </div>

                            <div class="text-muted small">
                                <i class="bi bi-geo-alt me-1"></i>@(s.Location ?? "—")
                            </div>
                        </div>

                        <div class="mt-2 text-muted small">
                            <i class="bi bi-person-badge me-1"></i>@s.SellerName
                        </div>
                    </div>

                    <div class="card-footer border-0 p-3 pt-0 d-flex justify-content-between align-items-center">
                        @* Category button (Craftsman only) *@
                        @if (isCraftsMan)
                        {
                            <a class="btn btn-sm btn-soft-eco"
                               asp-controller="CraftsMan"
                               asp-action="@(s.Type switch { "Material" => "PublicMaterialStore", "Machine" => "PublicMachineStore", "Rental" => "PublicRentalStore", "Auction" => "PublicAuctionStore", _ => "PublicMaterialStore" })">
                                <i class="bi bi-grid me-1"></i>Open Category
                            </a>
                        }
                        else
                        {
                            <span></span>
                        }

                        <a class="btn btn-sm btn-solid-eco"
                           asp-controller="@s.DetailController"
                           asp-action="@s.DetailAction"
                           asp-route-id="@s.Id">
                            Open <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>
}
